var isFreshLoad=!0,downloadDashboardProcessStatusInfo="",isDownoadItemStatusDialogBinded=!1,objectSelected=[],validData=[],successtext="Success";function onStatusClick(){ejs.popups.showSpinner(document.getElementById("download_item_status"));var e=document.getElementById("ProgressStages");$("#DownlodDashboardStatus").html(e),$("#ProgressStages").show(),setTimeout(function(){var e=$("#DownloadItemGrid").data("ejGrid"),t=e.getCurrentViewData()[e.getIndexByRow($("#DownloadItemGrid .e-gridcontent tr.e-row[aria-selected *='true']"))];if($("#progress-stages").empty(),null!=t&&null!=t.Stages&&null!=t.Stages)for(i=0;i<t.Stages.length;i++)t.Stages[i].Status==DownloadandUploadJobStatus.InProgress?$("#progress-stages").append('<li class="col-xs-12 no-padding"><div class="loader-blue loader-icon col-xs-2 no-padding" id="upload-dashboard-progress-loader-icon"><svg class="circular"><circle class="path" cx="8" cy="8" r="6" fill="none" stroke-width="2" stroke-miterlimit="10"></circle></svg></div><span class="progress-info col-xs-10 no-padding">'+t.Stages[i].Label+"</span ></li >"):t.Stages[i].Status==DownloadandUploadJobStatus.Success?$("#progress-stages").append('<li class="col-xs-12 no-padding"><i class="su su-success col-xs-2 no-padding"><span class="su-success path1"></span><span class="su-success path2"></span></i><span class="progress-info col-xs-10 no-padding">'+t.Stages[i].Label+"</span ></li >"):t.Stages[i].Status==DownloadandUploadJobStatus.Failed?$("#progress-stages").append('<li class="col-xs-12 no-padding"><i class="su su-failure col-xs-2 no-padding"><span class="su-failure path1"></span><span class="su-failure path2"></span><span class="su-failure path3"></span><span class="su-failure path4"></span></i><span class="progress-info col-xs-10 no-padding">'+t.Stages[i].Label+'<span id="error-message" style="display: none;">'+t.Stages[i].ErrorMessage+'</span><span id="click-know-more">'+window.Server.App.Localization.KnowMore+"</span ></span ></li > "):t.Stages[i].Status==DownloadandUploadJobStatus.YetToStart&&$("#progress-stages").append('<li class="col-xs-12 no-padding"><i class="su su-schedule-status col-xs-2 no-padding yet-to-start"></i><span class="progress-info col-xs-10 no-padding">'+t.Stages[i].Label+"</span ></li >");e=document.getElementById("download_item_status").ej2_instances;e[0].header='<span class="dialog-header-with-subtitle"><span class ="dialog-header-title">'+window.Server.App.Localization.DownloadDashboard+'</span><span class="item-name">'+t.ItemName+"</span></span>",e[0].show()},50),ejs.popups.hideSpinner(document.getElementById("download_item_status"))}function closeStatusInfo(){downloadDashboardProcessStatusInfo.hide()}function pushUrl(e){isFreshLoad?(history.replaceState(e,null,window.location.pathname+"?tab="+e),isFreshLoad=!1):history.pushState(e,null,window.location.pathname+"?tab="+e)}function fnOnUserGridActionBegin(e){var t,a=$("#search-downloaded-items").val(),o=(this.model.query._params.push({key:"searchKey",value:a}),[]),a=createLoader("DownloadItemGrid");if(this.element.ejWaitingPopup({template:$("#"+a)}),0<e.model.filterSettings.filteredColumns.length){for(t=0;t<e.model.filterSettings.filteredColumns.length;t++){var s=e.model.filterSettings.filteredColumns[t];o.push({PropertyName:s.field,FilterType:s.operator,FilterKey:s.value})}this.model.query._params.push({key:"filterCollection",value:o})}a=$("#DownloadItemGrid").data("ejGrid");objectSelected=[],null!=a.model.currentViewData&&objectSelected.length==a.model.currentViewData.length||($("#checkbox-header").prop("checked",!1),$("#bulk-download").attr("disabled",!0),"paging"!=e.requestType&&"searching"!=e.requestType)||$(".dashboard-selected-count").text(window.Server.App.Localization.Selected.format(0))}function fnCreate(e){$("#checkbox-header").change(headCheckboxOnChange)}function headCheckboxOnChange(e){var t=0,a=$("#DownloadItemGrid").data("ejGrid");if(1==$("#checkbox-header").prop("checked")){$(".checkbox-row").each(function(){$(this).prop("disabled")||($(this).prop("checked",!0),t++)}),$(".dashboard-selected-count").text(window.Server.App.Localization.Selected.format(t)),$("#bulk-download").attr("disabled",!1),a.multiSelectCtrlRequest=!0,a.selectRows(0,$(".checkbox-row").length+$(".checkbox-row-disabled").length);for(var o=0;o<$(".checkbox-row-disabled").length;o++){var s=$(".checkbox-row-disabled"),s=$($(s[o]).closest("td").parent()).index();a.selectRows(s)}objectSelected=[],objectSelected=$.extend(!0,objectSelected,searchdata.result),isSafari&&$(".checkbox-header-label").addClass("check")}else $(".checkbox-row").prop("checked",!1),objectSelected=[],a.clearSelection(),isSafari&&$(".checkbox-header-label").removeClass("check"),$(".dashboard-selected-count").text("Selected ("+t+")"),$("#bulk-download").attr("disabled",!0)}function setHeaderCheckedStatus(e){null!=e.getRows()&&(validData.length===objectSelected.length&&0<objectSelected.length?$("#checkbox-header").prop("checked",!0):$("#checkbox-header").prop("checked",!1))}function fnOnUserGridActionComplete(e){var t=$("#DownloadItemGrid").data("ejGrid"),a=($("#checkbox-header").prop("enabled",!1),$("#checkbox-header").change(headCheckboxOnChange),t.multiSelectCtrlRequest=!0,t.clearSelection(),$('[data-toggle="tooltip"]').tooltip(),showOrHideGridPager("#DownloadItemGrid"),t.model.query.queries),o=a.map(function(e,t){return e.fn}),s=(a.splice(o.indexOf("onPage"),1),searchdata=new ej.DataManager(t.model.currentViewData).executeLocal(t.model.query),validData=$.grep(searchdata.result,function(e){return e.Status==successtext}),[]);if($.map(searchdata.result,function(e){-1!=jQuery.inArray(JSON.stringify(e),$.map(objectSelected,JSON.stringify))&&s.push(e)}),objectSelected=[],objectSelected=$.extend(!0,objectSelected,s),"paging"==e.requestType||"sorting"==e.requestType||"refresh"==e.requestType||"filtering"==e.requestType||"searching"==e.requestType){for(var n=0;n<t.model.currentViewData.length;n++){var d=t.model.currentViewData[n],r=d.UserId;-1!=jQuery.inArray(JSON.stringify(d),$.map(objectSelected,JSON.stringify))&&($("#user_grid .checkbox-row#row-check"+r).prop("checked",!0),t.selectRows($($("#user_grid .checkbox-row#row-check"+r).closest("td").parent()).index()))}0!=objectSelected.length&&objectSelected.length===searchdata.result.length?$("#checkbox-header").prop("enabled",!0):$("#checkbox-header").prop("enabled",!1),$(".checkbox-row-disabled").length==searchdata.result.length?$("#checkbox-header").prop("disabled",!0):$("#checkbox-header").prop("disabled",!1)}}function fnRecordClick(e){var t,a;e.columnName!=window.Server.App.Localization.DownloadItemStatus&&(t=$("#DownloadItemGrid").data("ejGrid"),e.row.find(".checkbox-row").is(":checked")?(t.multiSelectCtrlRequest=!0,-1==jQuery.inArray(JSON.stringify(e.data),$.map(objectSelected,JSON.stringify))?objectSelected.push(e.data):t.selectRows(e.row.index())):(t.multiSelectCtrlRequest=!0,t.selectRows(e.row.index()),-1!=(a=jQuery.inArray(JSON.stringify(e.data),$.map(objectSelected,JSON.stringify)))&&(objectSelected.splice(a,1),t.selectRows(e.row.index()))),setHeaderCheckedStatus(t))}$(document).ready(function(){var e,t,a='<span class="dialog-header-with-subtitle"><span class ="dialog-header-title">'+window.Server.App.Localization.DownloadDashboard+'</span><span class="item-name"></span></span>',a=(isDownoadItemStatusDialogBinded?((t=document.getElementById("download_item_status").ej2_instances)[0].header=a,t[0].show()):((e=document.createElement("div")).setAttribute("id","download_item_status"),document.getElementById("base-container").appendChild(e),(t=new ejs.popups.Dialog({showOnInit:!1,visible:!1,allowDraggable:!1,enableResize:!1,width:460<window.innerWidth?"456px":window.innerWidth-10,height:"auto",showHeader:!1,isModal:!0,enableModal:!0,closeOnEscape:!0,header:a,showCloseIcon:!0,content:document.getElementById("DownlodDashboardStatus"),buttons:[{click:function(){t.hide(),$("#DownloadItemGrid").data("ejGrid").clearSelection()},buttonModel:{isPrimary:!0,cssClass:"app-btn-primary",content:window.Server.App.Localization.OKButton}}]})).appendTo(e),isDownoadItemStatusDialogBinded=!0),ejs.popups.createSpinner({target:document.getElementById("download_item_status")}),ejs.popups.setSpinner({type:"Material"}),$("#DownloadItemGrid").data("ejGrid"));$(".checkbox-row-disabled").length==a.model.dataSource.length&&$("#checkbox-header").prop("disabled",!0)}),$(document).on("click","#click-know-more",function(){$(this).parent().find("#error-message").is(":visible")?($(this).parent().find("#error-message").hide(),$(this).text(window.Server.App.Localization.KnowMore)):($(this).parent().find("#error-message").show(),$(this).text(window.Server.App.Localization.KnowLess))}),$(document).on("click","#clear-downloadfiles-search",function(){var e=$(this).prevAll("input"),t="#"+(e=""==e||null==e||e.length<=0?$(this).prev("div").find("input"):e).attr("id");e.val(""),$("#clear-downloadfiles-search").css("display","none"),""==e.val()&&(PerformSearch(t),$("#clear-downloadfiles-search").siblings("span.su-search").css("display","block")),$("#checkbox-header").prop("checked",!1)}),$(document).on("click",'a[data-toggle="tab"]',function(e){pushUrl($(e.target).attr("href").replace("#",""))}),$(document).on("click",'#DownloadItemGrid input[type="checkbox"]',function(){var e=$("#DownloadItemGrid .checkbox-row:checked").length;$(".dashboard-selected-count").text(window.Server.App.Localization.Selected.format(e)),1<e?$("#bulk-download").attr("disabled",!1):$("#bulk-download").attr("disabled",!0)}),$(document).on("click","#bulk-download",function(e){for(var t=[],a=$("#DownloadItemGrid").data("ejGrid"),o=a.getSelectedRecords(),t=[],s=0;s<o.length;s++)null!=o[s]&&t.push({JobId:o[s].JobId,ItemId:o[s].ItemId,Name:o[s].ItemName});ejs.popups.createSpinner({target:document.getElementById("server-app-container")}),ejs.popups.setSpinner({type:"Material"}),ejs.popups.showSpinner(document.getElementById("server-app-container")),$.ajax({type:"POST",url:bulkDownloadUrl,data:{data:JSON.stringify(t)},xhrFields:{responseType:"blob"},success:function(e){var t=document.createElement("a"),e=window.URL.createObjectURL(e);t.href=e,t.download="dashboard collection.zip",document.body.append(t),t.click(),t.remove(),window.URL.revokeObjectURL(e),$(".checkbox-row").prop("checked",!1),$("#checkbox-header").prop("checked",!1),$("#bulk-download").attr("disabled",!0),objectSelected=[],$(".dashboard-selected-count").text(window.Server.App.Localization.Selected.format(0)),a.clearSelection(),ejs.popups.hideSpinner(document.getElementById("server-app-container"))}})});